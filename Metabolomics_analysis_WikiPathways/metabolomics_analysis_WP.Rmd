---
title: "metabolomics_analysis"
author: 
- "ddedesener"
- "DeniseSl22"
date: "25/04/2022"
output:
 md_document:
    variant: markdown_github
always_allow_html: true
---

## Introduction
In this workflow, we will apply statistical analysis on metabolomics data and link the metabolites of interest to pathway data from WikiPathways.

First we download the required data.
```{r data_download,warning=FALSE, message=FALSE}
# Set Working Directory, download data and store in /Data folder
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
work_DIR <- getwd()

# Obtain a file locally by its url
install.packages("downloader")
fileUrl <- "https://ibdmdb.org/tunnel/products/HMP2/Metabolites/1723/HMP2_metabolomics.csv.gz?accessType=DOWNLOAD"
require(downloader)
download(fileUrl, "data/metabolomics.csv.gz", mode = "wb")

#Note: if the URL download does not work, the zipped file is located on GitHub to continue the rest of this script.
if(!"R.utils" %in% installed.packages()){install.packages("R.utils")}
library(R.utils)
gunzip("data/metabolomics.csv.gz", remove=FALSE)

remove(fileUrl)
```

Second, we perform data extraction from the file, and process the data
```{r data_import,warning=FALSE, message=FALSE}
##DATA CLEANUP:

# Read in the csv file with data (note this might take some time, 81867 rows in original dataset)
mSet <- read.csv("data/metabolomics.csv", na.strings=c("", "NA"))

#Replace all empty values with NA
mSet[mSet==""] <- NA

#remove all lines with an empty value for the column called "HDMB"
mSet_Cleaned <- mSet[!is.na(mSet$"HMDB...Representative.ID."),]

#Remove all elements without an actual HMDB ID:
mSet_Cleaned_Ion <- mSet_Cleaned[!grepl("redundant ion", mSet_Cleaned$HMDB...Representative.ID.),]

if(!"dplyr" %in% installed.packages()){install.packages("dplyr")}
library(dplyr)

#IDs ending with a * (indicating ...) are placed in a separate column (to keep track of for future reference)
mSet_Cleaned_Star <- mSet_Cleaned_Ion%>%mutate(Star = case_when(
 grepl("[*]",mSet_Cleaned_Ion$HMDB...Representative.ID.) ~ 1
))

#Update IDs with a * to regular IDs.
mSet_Cleaned_HMDB <- data.frame(lapply(mSet_Cleaned_Star, function(x) {
                  gsub("[*]", "", x)
             }))

#Update IDs To new HMDB structure
mSet_Cleaned_HMDB_NEW <- data.frame(lapply(mSet_Cleaned_HMDB, function(x) {
                  gsub("HMDB", "HMDB00", x)
             }))


remove(mSet,mSet_Cleaned, mSet_Cleaned_Ion, mSet_Cleaned_Star, mSet_Cleaned_HMDB)

##DATA PROCESSING:

#Remove metabolites with < 50% data (located in columns 8-553.
removeLines <- rowSums(is.na(mSet_Cleaned_HMDB_NEW[,8-553]))
fifty_percent <- floor((553-8)/2)

mSet_MissingDataCounted <- cbind(mSet_Cleaned_HMDB_NEW, removeLines)
mSet_NoMissingData <- subset(mSet_MissingDataCounted, removeLines <= fifty_percent)

#Convert intensity data to numeric values                         
mSet_NoMissingData[ , c(8:553)] <- apply(mSet_NoMissingData[ , c(8:553)], 2, function(x) as.numeric(as.character(x)))

##TODO ask Duygu what this step does?
#set the rest features as column mean 

##normalization (see https://doi.org/10.1177%2F1469066720918446 )
#Cube root transformation on intensity data
mSet_cube_root <- cbind(mSet_NoMissingData[,c(1:7,554,555)], mSet_NoMissingData[,8:553]^(1/3))

remove(mSet_Cleaned_HMDB_NEW, mSet_MissingDataCounted, mSet_NoMissingData)
```

## Calculate logFC and p-value
```{r basic_statistics, warning=FALSE, message=FALSE}
# The file called "sampleLabels" will be used to connect the column names to the correct disorder/control group.
##TODO: find location of this datasource, see issue  #7 on GitHub

##calculate logFC for 2 groups (CD vs control, UC vs control)  

##Calculate p-value for two groups based on two-tailed t-test.
```


## Volcano plot
--> Update script below, to create an Volcano plot without MetaboAnalystR

```{r volcano_plot,warning=FALSE, message=FALSE}
#See https://bioconductor.org/packages/devel/bioc/vignettes/EnhancedVolcano/inst/doc/EnhancedVolcano.html
if (!requireNamespace('BiocManager', quietly = TRUE))
    install.packages('BiocManager')
  BiocManager::install('EnhancedVolcano')

library(EnhancedVolcano)

```


Export the data:
```{r data_export, warning=FALSE, message=FALSE}
# Saving output
if(dir.exists("output"))#if the output folder already exist
  unlink("output", recursive=TRUE)#first delete the existing one
dir.create("output")#create a new output folder
```

